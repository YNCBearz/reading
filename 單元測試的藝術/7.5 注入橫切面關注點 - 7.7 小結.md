# 7.5 注入橫切面關注點 - 7.7 小結

## 7.5 注入橫切面關注點 (Cross-cutting concerns injection)

如果需要處理如時間、例外或log的橫切面關注點時，
使用先前介紹的依賴性注入技術的程式碼的可讀性較差，也不易維護。

>*請參考程式碼 TimeLogger.php*

---
## 7.6 為應用程式建立測試 API (Building a test API for your application)

在開始替應用程式撰寫測試之後，為了可測試性或測試的可讀性與可維護性，你最終都會進行重構，建立輔助 (utility) 方法、輔助類別及很多基礎設計。

### 7.6.1 使用繼承類別繼承模式 (Using test class inheritance patterns)

> DRY (Don't Repeat Yourself) 原則

透過設計基底類別，可以應用如下列方式來緩解測試程式中常見的問題：

- 重用輔助方法和工廠方法。
- 在不同類別上執行同一組測試 （稍後討論）。
- 使用共用的 setup 和 teardown 程式碼 （對整合測試一樣適用）。
- 從基底類別繼承而來的子類提供測試指引，方便開發人員撰寫測試。

**三種基本模式：**
1. 抽象測試基礎結構類別

>*請參考程式碼 LogAnalyzer.php*

2. 測試模板類別

測試模板類別是抽象類別，包含**一組**抽象測試方法。

你可以把一個介面看作一組行為約定：
**一組解析器類別都實作同樣的解析方法，行為相同，但是輸入型別不同。**

3. 抽象測試驅動類別

作者喜歡把這種模式稱作「填空」，是前一個方式的進階版。
在基底類別實作了測試方法，並提供抽象方法掛鉤供衍生子類實作。

> 重點在於，你並不是實際在測試一個類別，而是測試產品程式的一個介面或是基底類別。

4. 重構測試類別階層

以下列出重構測試類別可能的步驟：

(1) 重構：抽取基底類別 (superclass)
- 建立一個基底類別 (BaseXXXTests)
- 把工廠方法 (GetParser) 移至基底類別
- 把所有測試方法移至基底類別中
- 抽取期望的輸出，放到基底類別的公開欄位
- 抽取測試的輸入，放到抽象方法或衍生子類別需要建立的屬性

(2) 重構：使用抽象工廠方法，回傳介面
(3) 重構：找到測試方法中所有使用實際類別的地方，替換成使用這些類別的介面
(4) 在衍生子類中，完成抽象工廠方法，回傳實際類別

5. 使用 .NET 泛型來設計測試階層

你可以在基底類別使用泛型。使用泛型，衍生子類就不需要覆寫任何方法，只需要宣告要測試的型別。

### 7.6.2 建立測試輔助類別和方法 (Creating test utility classes and methods)

撰寫測試時，你會建立很多簡單輔助方法。

可能會有類似這些的輔助類別：
- 建立複雜物件或測試常用物件的工廠方法。
- 系統初始化方法（例如：測試開始前要設定系統狀態、修改log機制以便使用虛設常式來替代 log 管理器等等）
- 物件設定方法（例如：設定物件內部狀態）
- 設定或讀取外部資源的方法，如讀取資料庫、設定檔案和測試輸入值檔案。整合測試或系統測試比較常見。
- 特別驗證的輔助方法，對某些複雜或需要重覆驗證的東西進行驗證。

你可能會把輔助方法進行重構，而產生以下的輔助類別：
- 特別的驗證輔助類別，包含所有自訂的驗證方法。
- 特別的工廠類別，包含所有的工廠方法。
- 特別的設定類別或資料庫設定類別，包含整合測試風格的操作。

### 7.6.3 把你的 API 介紹給開發人員 (Making your API known to developers
)

有幾種方式可以讓大家了解，並使用你的 API:
- Pair Programming.
- 準備**輕量**說明文件或速查表，列出 API 的種類和存放位置。要確保文件內容是最新的，你可以把文件的產生過程自動化。
- 在團隊會議討論 API 的變更：一兩句話概要說明主要變更，以及在哪裡可以找到主要變更內容。
- 新成員加入時，和他們一起過一次說明文件。
- 進行測試程式碼審查時（在一般程式審查之外），確保測試程式達到了可讀性、可維護性和正確性的標準。

---
## 7.7 小結 (Summary)

- 無論何種測試，請將測試自動化，盡可能地頻繁執行測試，盡可能地持續進行產品交付。
- 把整合測試與單元測試分開
- 按照專案和種類來組織測試，把測試分別放在不同專案、資料夾或命名空間。
- 使用測試類別階層，對一個階層中的相關類別，進行同一組測試。
- 可讀性通常是不使用繼承階層的主要原因。
- 把你的 API 介紹給團隊成員，減少開發資源浪費。
---

